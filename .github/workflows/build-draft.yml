name: Build & Create Draft Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version number (0.9.1)"
        required: true
        default: "0.9.1"
      snap_channel:
        description: "Snap channel to build for (stable)"
        required: false
        default: "stable"

permissions:
  contents: write 

jobs:
  build:
    name: Build Snap Package
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Snapcraft and build snap
        uses: snapcore/action-build@v1
        with: 
          path: ./src
          
      - name: Find builted snap file
        id: find_snap
        run: |
          SNAP_FILE=$(find . -name "*.snap" -type f | head -n 1)
          if [ -z "$SNAP_FILE" ]; then
          echo "The .snap file was not found! The previous build step failed or did not place the file in the expected location."
          echo "Snap-File: $SNAP_FILE"
          exit 1
          fi
          echo "Snap-File: $SNAP_FILE"
          echo "snap_file=$SNAP_FILE" >> $GITHUB_OUTPUT
          
      - name: Upload snap artifact
        uses: actions/upload-artifact@v4
        with:
          name: fastboot-assistant
          path: ${{ steps.find_snap.outputs.snap_file }}
      
      - name: Find latest changelog file
        id: changelog
        run: |
          DIR=""
          if [ -d "CHANGELOG" ]; then DIR="CHANGELOG"; fi
          if [ -d "CHNAGELOG" ]; then DIR="CHNAGELOG"; fi

          if [ -z "$DIR" ]; then
            echo "Changelog directory not found!"
            exit 1
          fi

          echo "Using directory $DIR"

          VERSION_LIST=$(for f in "$DIR"/v.*.md; do
              [ -e "$f" ] || continue
              ver=$(basename "$f" | sed -E 's/^v\.([0-9]+\.[0-9]+\.[0-9]+)\.md$/\1/')
              echo "$ver $f"
            done)

          if [ -z "$VERSION_LIST" ]; then
            echo "No matching changelog files found!"
            exit 1
          fi

          BEST_LINE=$(echo "$VERSION_LIST" | sort -V | tail -n 1)
          FILE=$(echo "$BEST_LINE" | awk '{print $2}')

          echo "Newest changelog file $FILE"
          echo "file=$FILE" >> $GITHUB_OUTPUT

          CONTENT=$(cat "$FILE" | sed 's/%/%25/g')
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create Draft Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: "Fastboot Assistant v${{ github.event.inputs.version }}"
          draft: true
          prerelease: false
          body: |
            ## Fastboot Assistant v${{ github.event.inputs.version }}

            **Changelog (automatisch aus Datei):**

            ${{ steps.changelog.outputs.content }}

            **Build channel:** `${{ github.event.inputs.snap_channel }}`
          files: |
            ${{ steps.find_snap.outputs.snap_file }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


